
after executing the powershell command it checks if it returns 0 or not zero, in c/c++ language 0 means successfull operation and not zero means failure.

![[Pasted image 20240225190532.png]]

and we can make sure of this by looking at the assembly. if the result returned from executing the powershell command is not zero it will show `Error downloading the file.\n` and if it's zero it will show this `File downloaded successfully.\n` and then execute another function `sub_140001200` which takes 2 arguments the first one being the value `hack` and the second one is the path to the malicious file downloaded from the remote c2 server `C:\\Windows\\System32\\persist_hack.ps1`

[![image.png](https://i.postimg.cc/5tCR1Hsj/image.png)](https://postimg.cc/SXmrfKFp)

double click on this function `sub_140001200` to analyze its instructions

[![image.png](https://i.postimg.cc/x1C81mNf/image.png)](https://postimg.cc/GHWdMHjV)

It opens a registry key `SOFTWARE\Microsoft\Windows\CurrentVersion\Run` under `HKEY_CURRENT_USER` hive using `RegOpenKeyExA` function

checks if the registry key is opened successfully `if(!result)` and if it's opened successfully it writes the path to the malicious file `C:\\Windows\\System32\\persist_hack.ps1` **(lpData)** to the registry under the specified value name `hack` **(lpValueName)** using `RegSetValueExA` function. and Finally, it closes the opened registry key using `RegCloseKey` function.

so as a conclusion the malware is trying to autorun the malicious file as a mechanism of persistance which means the malicious file will be run every time the system starts up.

if we open the registry editor and look for the registry key found on the reversed code

[![image.png](https://i.postimg.cc/cHppnpJ1/image.png)](https://postimg.cc/VrFZyHM2)

## Flag : 

```
DEFESNSYS{HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run}
```


