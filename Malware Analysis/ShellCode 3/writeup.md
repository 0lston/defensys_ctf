
in the previous challenge we have explained that the malware is looking for the process id for `notepad.exe` and then opens a handle to the process using `OpenProcess` and then allocates virtual memory in the process `notepad.exe` using `VirtualAllocEx` and then decrypts the encrypted shellcode buffer using **xor** after this writes the decrypted shellcode buffer into the space allocated using `WriteProcessMemory` and then executes the shellcode using the `CreateRemoteThread` function.

### Encrypted Shellcode bytes : 

so we can find the encrypted shellcode bytes before its being decrypted using the function `sub_140001000`

[![image.png](https://i.postimg.cc/SRPQVfGD/image.png)](https://postimg.cc/5QwM2vTC)

we can see that lpBuffer is passed to the function `sub_140001120` as the `second argument` so let's return to the main function and see if we can get its value in the assembly

[![image.png](https://i.postimg.cc/BnHYSZRv/image.png)](https://postimg.cc/MnZbtw6k)

so let's double click on it and we will get its bytes in hex

[![image.png](https://i.postimg.cc/rwjh0ZF6/image.png)](https://postimg.cc/687VF0vz)

**first 6 hex in encrypted shellcode** => `8F29FA8B9E89`

### Decrypted Shellcode bytes : 

to view the value of the decrypted shellcode buffer we have to do it dynamically since the shellcode get decrypted during runtime after being passed to the function `sub_140001000`

[![image.png](https://i.postimg.cc/SRPQVfGD/image.png)](https://postimg.cc/5QwM2vTC)

after this its being written to the allocated memory using `WriteProcessMemory` and the decrypted shellcode buffer is passed to this windows api function as the third argument 

[![image.png](https://i.postimg.cc/HxyRy0hQ/image.png)](https://postimg.cc/7GqKvzD6)

let's set a breakpoint on the `lpBuffer assembly instruction` since the value of the lpBuffer (decrypted shellcode) is passed from the register `rsi` to `r8`

![[Pasted image 20240225121726.png]]

after this we have to se the debugger to `local windows debugger` but before clicking on the green start button to run the program we have to make sure that notepad process is run since it checks first if there is any process on the system called `notepad.exe` and if it doesn't find a matching process it will exist without injecting the shellcode.

[![image.png](https://i.postimg.cc/T3JVNKZn/image.png)](https://postimg.cc/VJ50dksN)

now let's proceed by clicking on the start green button to start the program and it will stop at the breakpoint we have set

[![image.png](https://i.postimg.cc/vHLb4yJ0/image.png)](https://postimg.cc/vcBpKJHn)

and we will stop on the instruction we have set a breakpoint into, the instruction is not yet executed, the instruction moves the lpBuffer value (decrypted shellcode buffer) from the `rsi` register to the `r8` register that means before this instruction is executed its value is in the **rsi register** to view it double click on the rsi on the right side panel and you will get the address copy it

[![image.png](https://i.postimg.cc/VkwtQYw1/image.png)](https://postimg.cc/xcs8LVqF)

now go the `Hex View panel` in the bottom panel and click on `CTRL + G` and paste the address copied and click on ok

[![image.png](https://i.postimg.cc/tJmBvYwX/image.png)](https://postimg.cc/wRL57T9P)

now to search for the address you copied click on `CTRL + F` remove the 0x and paste the rest of the address and click on ok

[![image.png](https://i.postimg.cc/pdXqvQv2/image.png)](https://postimg.cc/yDtFXZW5)

and we will get the decrypted shellcode bytes

[![image.png](https://i.postimg.cc/RZbn3wfC/image.png)](https://postimg.cc/750LdGmj)

**first 6 hex in decrypted shellcode** => `FC4883E4F0E8`

we can also find the decrypted shellcode injected into notepad using processHacker since the allocated memory has a protection 0x20 which is  `PAGE_EXECUTE_READ` 

[![image.png](https://i.postimg.cc/SsRT661Z/image.png)](https://postimg.cc/PpGQhwjZ)

[![image.png](https://i.postimg.cc/44WqgT4T/image.png)](https://postimg.cc/fk0Bcp0H)

so we will open **process hacker** and search for the **notepad process injected** double click on it and click on the **memory section** and search for **RX sections** `(RX => EXECUTE_READ)`

[![image.png](https://i.postimg.cc/zvSx5xyG/image.png)](https://postimg.cc/2LyQ7Fds)

click on protection field to sort based on the protection field and make searching for suspicious RX section easier, after scrolling through all RX sections we can find 4 sections that are not used by any files on the system so this is very suspicious since it indicates that those sections maybe are injected by unwanted party which is the attacker, double click on any one of them

[![image.png](https://i.postimg.cc/NLvvCJWG/image.png)](https://postimg.cc/wR2r7Vqn)

and we've got the decrypted shellcode injected into notepad process

[![image.png](https://i.postimg.cc/wv3z1sXz/image.png)](https://postimg.cc/PpG9cJVV)

**first 6 hex in decrypted shellcode** => `FC4883E4F0E8`
## Flag : 

```
DEFENSYS{8F29FA8B9E89_FC4883E4F0E8}
```
